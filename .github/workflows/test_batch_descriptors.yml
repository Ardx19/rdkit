name: Test Batch Descriptors

on:
  push:
    branches: [ feature/expand-batch-descriptors ]
  pull_request:
    branches: [ master ]

# Cancel redundant runs to save minutes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache build directory
      uses: actions/cache@v3
      id: cache-build
      with:
        path: |
          build
          lib
          rdkit/*.so
          rdkit/Chem/*.so
        key: ${{ runner.os }}-rdkit-build-${{ hashFiles('Code/GraphMol/Descriptors/**/*.cpp', 'Code/GraphMol/Descriptors/**/*.h') }}
        restore-keys: |
          ${{ runner.os }}-rdkit-build-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libboost-all-dev libeigen3-dev libfreetype6-dev
        pip install numpy pytest

    - name: Build RDKit
      if: steps.cache-build.outputs.cache-hit != 'true'
      run: |
        echo "Cache miss - building from scratch..."
        export RDBASE=$PWD
        rm -rf build lib/rdkit rdkit/*.so rdkit/Chem/*.so
        mkdir build && cd build
        cmake .. \
          -DRDK_INSTALL_INTREE=ON \
          -DRDK_BUILD_PYTHON_WRAPPERS=ON \
          -DRDK_BUILD_CPP_TESTS=ON \
          -DCMAKE_BUILD_TYPE=Release \
          -DRDK_BUILD_DESCRIPTORS3D=OFF \
          -DRDK_BUILD_MAEPARSER_SUPPORT=OFF \
          -DRDK_BUILD_COORDGEN_SUPPORT=OFF \
          -DRDK_USE_FLEXBISON=OFF \
          -DRDK_BUILD_THREADSAFE_SSS=OFF \
          -DRDK_TEST_MULTITHREADED=OFF \
          -DRDK_BUILD_CHEMDRAW_SUPPORT=OFF \
          -DRDK_BUILD_AVALON_SUPPORT=OFF \
          -DRDK_BUILD_INCHI_SUPPORT=OFF \
          -DRDK_BUILD_FREESASA_SUPPORT=OFF \
          -DRDK_BUILD_YAEHMOP_SUPPORT=OFF \
          -DRDK_BUILD_XYZ2MOL_SUPPORT=OFF \
          -DRDK_BUILD_CAIRO_SUPPORT=OFF \
          -DRDK_BUILD_SWIG_WRAPPERS=OFF \
          -DRDK_BUILD_JAVA_WRAPPERS=OFF \
          -DRDK_BUILD_COMIC_FONT=OFF \
          -DPYTHON_EXECUTABLE=$(which python3)
        make -j2 Descriptors rdMolDescriptors
        make install

    - name: Use cached build
      if: steps.cache-build.outputs.cache-hit == 'true'
      run: |
        echo "Cache hit - using prebuilt binaries!"
        ls -la lib/*.so 2>/dev/null || echo "No libraries in lib/"
        ls -la rdkit/Chem/*.so 2>/dev/null || echo "No Python modules"

    - name: Run tests
      run: |
        export RDBASE=$PWD
        export PYTHONPATH=$RDBASE:$PYTHONPATH
        export LD_LIBRARY_PATH=$RDBASE/lib:$LD_LIBRARY_PATH
        cd build
        ctest -R pyBatchDescriptors --output-on-failure

    - name: Quick validation test
      run: |
        export RDBASE=$PWD
        export PYTHONPATH=$RDBASE:$PYTHONPATH
        export LD_LIBRARY_PATH=$RDBASE/lib:$LD_LIBRARY_PATH
        python3 << 'PYEOF'
        from rdkit import Chem
        from rdkit.Chem import rdMolDescriptors as rdMD
        import numpy as np

        # Test 1: Check descriptor count
        names = rdMD.GetBatchDescriptorNames()
        assert len(names) == 45, f"Expected 45 descriptors, got {len(names)}"
        print(f"✓ {len(names)} descriptors available")

        # Test 2: Test batch calculation
        mols = [Chem.MolFromSmiles(s) for s in ['CCO', 'c1ccccc1', 'CC(=O)O']]
        results = rdMD.CalcDescriptorsBatch(mols, "all")
        assert results.shape == (3, 45), f"Expected shape (3, 45), got {results.shape}"
        print(f"✓ Batch calculation works: shape {results.shape}")

        # Test 3: Test individual batch functions
        chi0v = rdMD.CalcChi0v(mols)
        assert len(chi0v) == 3
        print(f"✓ CalcChi0v works: {chi0v}")

        kappa1 = rdMD.CalcKappa1(mols)
        assert len(kappa1) == 3
        print(f"✓ CalcKappa1 works: {kappa1}")

        print("\n✅ All tests passed!")
        PYEOF
